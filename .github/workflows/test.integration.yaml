name: Test - Integration (End-to-End)

on:
  push:
    branches:
      - "sy-2769-integration-test-development"
  workflow_dispatch:

env:
  CACHE_SCOPE: build-synnax

jobs:
  build:
    name: Build Synnax
    runs-on: [self-hosted, linux]
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Force Quit Synnax Processes
        run: |
          mkdir -p $HOME/Desktop
          rm -rf $HOME/Desktop/*
          echo "Checking for existing synnax processes..."
          if pgrep -f "synnax" > /dev/null; then
            echo "Found synnax processes. Terminating..."
            pkill -f "synnax" || true
            sleep 2
            # Force kill if still running
            if pgrep -f "synnax" > /dev/null; then
              echo "Force killing remaining synnax processes..."
              pkill -9 -f "synnax" || true
            fi
            echo "All synnax processes terminated."
          else
            echo "No synnax processes found."
          fi

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Update Submodules
        run: git submodule update --init --recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            g++ \
            cmake \
            libsystemd-dev \
            pkg-config

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ env.CACHE_SCOPE }}-self-hosted-linux
          repository-cache: true

      - name: Build Driver
        run: |
          bazel build --enable_platform_specific_config -c opt --config=hide_symbols --announce_rc //driver

      - name: Get Version
        id: version
        working-directory: synnax
        run: |
          echo "VERSION=$(cat pkg/version/VERSION)" >> $GITHUB_OUTPUT

      - name: Move Driver to Assets
        run: |
          mkdir -p synnax/pkg/service/hardware/embedded/assets
          cp bazel-bin/driver/driver synnax/pkg/service/hardware/embedded/assets/driver

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.work
          cache-dependency-path: go.work.sum

      - name: Download Go Dependencies
        working-directory: synnax
        run: go mod download

      - name: Build Synnax Server
        working-directory: synnax
        run: |
          go build -tags driver -o synnax-v${{ steps.version.outputs.VERSION }}-linux

      - name: Copy Binaries to Desktop
        run: |      
          cp bazel-bin/driver/driver $HOME/Desktop/synnax-driver
          cp synnax/synnax-v${{ steps.version.outputs.VERSION }}-linux $HOME/Desktop/synnax
          echo "Binaries created in $HOME/Desktop:"
          ls -la $HOME/Desktop/synnax*

  deploy:
    name: Deploy Synnax Service
    runs-on: [self-hosted, linux]
    needs: build
    steps:
      - name: Install and Start Synnax as Service
        run: |
          echo "Creating systemd service for Synnax..."
          
          # Create necessary directories with proper permissions
          echo "=== Creating Required Directories ==="
          sudo mkdir -p /var/lib/synnax-driver
          sudo chown $USER:$USER /var/lib/synnax-driver
          sudo chmod 755 /var/lib/synnax-driver
          
          # Also create a local data directory as backup
          mkdir -p $HOME/synnax-data
          
          sudo tee /etc/systemd/system/synnax.service > /dev/null <<EOF
          [Unit]
          Description=Synnax Server
          After=network.target
          
          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=$HOME/synnax-data
          ExecStart=$HOME/Desktop/synnax start -mi
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          Environment=SYNNAX_DATA_DIR=$HOME/synnax-data
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Debug: Check if binary exists and has proper permissions
          echo "=== Binary Debug ==="
          ls -la $HOME/Desktop/synnax*
          echo "Binary size: $(stat -c%s $HOME/Desktop/synnax)"
          echo "Binary permissions: $(stat -c%a $HOME/Desktop/synnax)"
          
          # Debug: Try running the binary manually to see what error it produces
          echo "=== Manual Run Test ==="
          cd $HOME/Desktop
          if timeout 10 ./synnax start -mi; then
            echo "✅ Binary runs successfully manually"
          else
            echo "❌ Binary failed when run manually"
            echo "Exit code: $?"
          fi
          
          # Debug: Check for missing dependencies or configuration
          echo "=== Dependency Check ==="
          echo "Checking for required files and directories..."
          
          # Check if required directories exist
          if [ -d "$HOME/Desktop" ]; then
            echo "✅ Desktop directory exists"
          else
            echo "❌ Desktop directory missing"
          fi
          
          # Check if there are any config files needed
          if [ -f "$HOME/Desktop/config.yaml" ] || [ -f "$HOME/Desktop/.env" ]; then
            echo "✅ Config files found"
            ls -la $HOME/Desktop/config.* $HOME/Desktop/.env 2>/dev/null || echo "No config files found"
          else
            echo "ℹ️ No config files found (this might be expected)"
          fi
          
          # Check system dependencies
          echo "=== System Dependencies ==="
          if command -v ldd >/dev/null 2>&1; then
            echo "Checking binary dependencies..."
            ldd $HOME/Desktop/synnax 2>/dev/null || echo "ldd failed or binary is statically linked"
          fi
          
          # Verify directory permissions
          echo "=== Directory Permissions ==="
          echo "Checking /var/lib/synnax-driver permissions:"
          ls -la /var/lib/synnax-driver
          echo "Checking $HOME/synnax-data permissions:"
          ls -la $HOME/synnax-data
          
          # Test if we can write to the directories
          echo "=== Write Permission Test ==="
          if touch /var/lib/synnax-driver/test-write 2>/dev/null; then
            echo "✅ Can write to /var/lib/synnax-driver"
            rm /var/lib/synnax-driver/test-write
          else
            echo "❌ Cannot write to /var/lib/synnax-driver"
          fi
          
          if touch $HOME/synnax-data/test-write 2>/dev/null; then
            echo "✅ Can write to $HOME/synnax-data"
            rm $HOME/synnax-data/test-write
          else
            echo "❌ Cannot write to $HOME/synnax-data"
          fi
          
          sudo systemctl daemon-reload
          sudo systemctl stop synnax || true
          sudo systemctl enable synnax
          sudo systemctl start synnax
          
          echo "Waiting for Synnax service to start and stabilize..."
          sleep 15
          
          # Check service status
          echo "=== Service Status ==="
          sudo systemctl status synnax
          
          # Wait a bit more and check again
          sleep 10
          
          # Verify service is actually running and responding
          echo "=== Health Check ==="
          if sudo systemctl is-active --quiet synnax; then
            echo "Service is active, checking if it's responding on port 9090..."
            
            # Try to connect to the service
            if timeout 10 bash -c 'until nc -z localhost 9090; do sleep 1; done'; then
              echo "✅ Synnax service is responding on port 9090"
            else
              echo "❌ Service is running but not responding on port 9090"
              echo "=== Recent logs ==="
              sudo journalctl -u synnax --no-pager -n 20
              exit 1
            fi
          else
            echo "❌ Service failed to start"
            echo "=== Recent logs ==="
            sudo journalctl -u synnax --no-pager -n 20
            exit 1
          fi
          
          echo "Synnax service installed and started successfully"
          echo "Check logs with: sudo journalctl -u synnax -f"
          echo "Manage service with: sudo systemctl [start|stop|restart|status] synnax"

      - name: Verify Service Health
        run: |
          echo "=== Final Service Verification ==="
          
          # Check if service is still running
          if sudo systemctl is-active --quiet synnax; then
            echo "✅ Service is active"
          else
            echo "❌ Service is not active"
            sudo systemctl status synnax
            exit 1
          fi
          
          # Check if it's listening on port 9090
          if netstat -tlnp | grep :9090; then
            echo "✅ Service is listening on port 9090"
          else
            echo "❌ Service is not listening on port 9090"
            exit 1
          fi
          
          # Show recent logs to verify no errors
          echo "=== Recent Service Logs ==="
          sudo journalctl -u synnax --no-pager -n 10
          
          echo "Service verification complete - Synnax is ready for testing"

  test:
    name: Run Test Conductor
    runs-on: [self-hosted, linux]
    needs: deploy
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Update Submodules
        run: git submodule update --init --recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set up Poetry
        run: |
          sudo apt-get update
          sudo apt-get install -y curl python3-pip
          curl -sSL https://install.python-poetry.org | python3 -
          
          # Add Poetry to PATH for this session
          export PATH="$HOME/.local/bin:$PATH"
          
          # Verify installation
          poetry --version

      - name: Check System Python
        run: |
          echo "=== System Python Info ==="
          python3 --version
          python3 -c "import sys; print(f'Python path: {sys.executable}')"
          
          echo "=== System Pydantic Check ==="
          python3 -c "import pydantic; print(f'System Pydantic: {pydantic.__version__}')" 2>/dev/null || echo "No system Pydantic found"
          
          echo "=== Poetry Python Info ==="
          cd integration/py
          export PATH="$HOME/.local/bin:$PATH"
          poetry env info
          poetry run python -c "import sys; print(f'Poetry Python path: {sys.executable}')"

      - name: Install Dependencies
        working-directory: integration/py
        run: |
          # Ensure Poetry is in PATH
          export PATH="$HOME/.local/bin:$PATH"
          
          # Clean any existing virtual environment and reinstall
          poetry env remove --all || true
          
          # Force install the correct Pydantic version first
          poetry add "pydantic>=2.11.5,<3.0" --no-cache
          
          # Install all other dependencies
          poetry install --no-cache
          
          # Verify Pydantic version
          poetry run python -c "import pydantic; print(f'Pydantic version: {pydantic.__version__}')"
          
          # Check what's actually installed
          poetry show pydantic

      - name: Debug Imports
        working-directory: integration/py
        run: |
          # Ensure Poetry is in PATH for this step
          export PATH="$HOME/.local/bin:$PATH"
          
          # Check what's available in synnax module
          poetry run python -c "
          try:
              import synnax
              print('Synnax imported successfully')
              print(f'Synnax version: {synnax.__version__}')
          except Exception as e:
              print(f'Error importing synnax: {e}')
              import traceback
              traceback.print_exc()
          "

      - name: Run Conductor Test
        working-directory: integration/test/py/framework
        run: |
          # Ensure Poetry is in PATH for this step
          export PATH="$HOME/.local/bin:$PATH"
          
          # Run the test from the correct directory, pointing to the pyproject.toml location
          poetry run --directory ../../py python3 framework/Test_Conducter.py --name test_conductor --sequence ../testcases/basic_tests.json